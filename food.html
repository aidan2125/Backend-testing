<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Travique | Food Finder</title>
    <link rel="stylesheet" href="css/food.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-784GHrzxkNJfJKZhF4cu9N87ESyk0ZM&libraries=places"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body class="tips-page">
    <div class="top-bar">
      <h2><i class="fas fa-utensils"></i> Food Finder</h2>
      <button class="back-btn" onclick="window.location.href='dashboard.html'">
        <i class="fas fa-arrow-left"></i> Dashboard
      </button>
    </div>
    <div class="container mx-auto p-4 max-w-3xl" style="margin-top: 110px">
      <h1
        class="text-3xl font-bold text-center mb-6 text-primary-dark tracking-tight"
      >
        South Africa Travel: Find Restaurants & Stores
      </h1>
      <div class="flex justify-center mb-6 flex-wrap gap-3">
        <button
          id="findRestaurants"
          class="action-btn bg-blue-500 hover:bg-blue-600 text-white px-5 py-2"
        >
          Find Restaurants
        </button>
        <button
          id="findStores"
          class="action-btn bg-green-500 hover:bg-green-600 text-white px-5 py-2"
        >
          Find Stores
        </button>
      </div>
      <div class="search-bar-container mb-6">
        <input
          type="text"
          id="cuisine-type"
          placeholder="Search cuisine or restaurant..."
        />
        <button id="search-restaurants">
          <i class="fas fa-search mr-1"></i>Search
        </button>
        <button id="search-current">
          <i class="fas fa-location-arrow mr-1"></i>Nearby
        </button>
      </div>
      <div id="map" class="mb-6 fade-in"></div>
      <div id="results" class="bg-white p-4 rounded shadow fade-in"></div>
    </div>
    <script>
      let map,
        service,
        infowindow,
        userLocation,
        markers = [];

      function clearMarkers() {
        markers.forEach((marker) => marker.setMap(null));
        markers = [];
      }

      function initMap() {
        const defaultLocation = { lat: -26.2041, lng: 28.0473 };
        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultLocation,
          zoom: 12,
          styles: [
            { elementType: "geometry", stylers: [{ color: "#e0eafc" }] },
            {
              elementType: "labels.text.stroke",
              stylers: [{ color: "#ffffff" }],
            },
            {
              elementType: "labels.text.fill",
              stylers: [{ color: "#246071" }],
            },
            {
              featureType: "poi",
              elementType: "geometry",
              stylers: [{ color: "#f7fbff" }],
            },
            {
              featureType: "road",
              elementType: "geometry",
              stylers: [{ color: "#cfdef3" }],
            },
          ],
        });
        infowindow = new google.maps.InfoWindow();

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              map.setCenter(userLocation);
              new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Your Location",
                icon: {
                  url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                },
              });
            },
            () => {
              userLocation = defaultLocation;
              map.setCenter(userLocation);
            },
          );
        } else {
          userLocation = defaultLocation;
        }
        service = new google.maps.places.PlacesService(map);
      }

      function searchPlaces(type) {
        if (!userLocation) {
          alert("Location not yet available. Please wait...");
          return;
        }
        clearMarkers();
        const request = {
          location: userLocation,
          radius: 5000,
          type: type,
        };
        service.nearbySearch(request, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            displayResults(results, type);
            addMarkers(results);
          } else {
            document.getElementById("results").innerHTML =
              `<p class="text-red-500">No ${type}s found nearby.</p>`;
          }
        });
      }

      function displayResults(places, type) {
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = `<h2 class="text-xl font-semibold mb-3 text-primary-dark">${type.charAt(0).toUpperCase() + type.slice(1)}s Nearby</h2>`;
        if (!places.length) {
          resultsDiv.innerHTML += `<p class="text-gray-500">No results found.</p>`;
          return;
        }
        places.forEach((place) => {
          const placeDiv = document.createElement("div");
          placeDiv.className = "result-card fade-in";
          placeDiv.innerHTML = `
          <div class="result-title">${place.name}</div>
          <div class="result-address"><i class="fas fa-map-marker-alt text-primary mr-1"></i> ${place.vicinity}</div>
          <div class="result-rating"><i class="fas fa-star"></i> ${place.rating ? place.rating + "/5" : "N/A"}</div>
        `;
          resultsDiv.appendChild(placeDiv);
        });
      }

      function addMarkers(places) {
        places.forEach((place) => {
          const marker = new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            title: place.name,
            icon: {
              url: "http://maps.google.com/mapfiles/ms/icons/orange-dot.png",
            },
          });
          markers.push(marker);
          marker.addListener("click", () => {
            infowindow.setContent(`
            <div style="font-family:Quicksand,sans-serif;">
              <strong>${place.name}</strong><br>
              ${place.vicinity}<br>
              <span style="color:#ff8c42;">Rating: ${place.rating ? place.rating + "/5" : "N/A"}</span>
            </div>
          `);
            infowindow.open(map, marker);
          });
        });
      }

      document
        .getElementById("findRestaurants")
        .addEventListener("click", () => searchPlaces("restaurant"));
      document
        .getElementById("findStores")
        .addEventListener("click", () => searchPlaces("store"));

      document
        .getElementById("search-restaurants")
        .addEventListener("click", function () {
          const cuisine = document.getElementById("cuisine-type").value.trim();
          if (!userLocation || !cuisine) {
            alert("Enter a cuisine and ensure location is available.");
            return;
          }
          clearMarkers();
          const request = {
            location: userLocation,
            radius: 5000,
            keyword: cuisine,
            type: "restaurant",
          };
          service.nearbySearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              displayResults(results, "restaurant");
              addMarkers(results);
            } else {
              document.getElementById("results").innerHTML =
                `<p class="text-red-500">No restaurants found for "${cuisine}".</p>`;
            }
          });
        });

      document
        .getElementById("search-current")
        .addEventListener("click", function () {
          searchPlaces("restaurant");
        });

      document
        .getElementById("cuisine-type")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            document.getElementById("search-restaurants").click();
          }
        });

      window.onload = initMap;
    </script>
  </body>
</html>
