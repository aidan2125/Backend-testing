<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Travique | Food Finder</title>
    <link rel="stylesheet" href="css/food.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <meta name="theme-color" content="#ff6b35" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  </head>
  <body class="food-finder-page">
    <!-- Loading Screen -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner">
        <div class="spinner-ring"></div>
        <div class="loading-text">Finding delicious places...</div>
      </div>
    </div>

    <!-- Modern Header with Search -->
    <header class="modern-header" id="header">
      <div class="header-top">
        <button
          class="back-btn dynamic-btn"
          onclick="window.location.href='dashboard.html'"
        >
          <i class="fas fa-arrow-left"></i>
        </button>
        <div class="header-title">
          <h1><i class="fas fa-utensils"></i> Food Finder</h1>
          <span class="location-indicator" id="locationIndicator">
            <i class="fas fa-map-marker-alt"></i> Getting location...
          </span>
        </div>
        <button class="menu-toggle" id="menuToggle">
          <i class="fas fa-filter"></i>
        </button>
      </div>

      <!-- Quick Search Bar -->
      <div class="quick-search-container">
        <div class="search-input-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input
            type="text"
            id="quickSearch"
            placeholder="Search restaurants, cuisine..."
            autocomplete="off"
          />
          <button class="voice-search-btn" id="voiceSearch">
            <i class="fas fa-microphone"></i>
          </button>
          <!-- Search Dropdown -->
          <div class="search-dropdown" id="searchDropdown">
            <div class="dropdown-section">
              <h4>Suggested Locations</h4>
              <div class="location-suggestions" id="locationSuggestions">
                <!-- Location suggestions will be populated here -->
              </div>
            </div>
            <div class="dropdown-section">
              <h4>Restaurants Near You</h4>
              <div class="restaurant-suggestions" id="restaurantSuggestions">
                <!-- Restaurant suggestions will be populated here -->
              </div>
            </div>
            <div class="dropdown-section">
              <h4>Popular Searches</h4>
              <div class="popular-searches" id="popularSearches">
                <div
                  class="suggestion-item"
                  data-type="cuisine"
                  data-value="pizza"
                >
                  <i class="fas fa-pizza-slice"></i>
                  <span>Pizza places</span>
                </div>
                <div
                  class="suggestion-item"
                  data-type="cuisine"
                  data-value="coffee"
                >
                  <i class="fas fa-coffee"></i>
                  <span>Coffee shops</span>
                </div>
                <div
                  class="suggestion-item"
                  data-type="cuisine"
                  data-value="sushi"
                >
                  <i class="fas fa-fish"></i>
                  <span>Sushi restaurants</span>
                </div>
                <div
                  class="suggestion-item"
                  data-type="cuisine"
                  data-value="burger"
                >
                  <i class="fas fa-hamburger"></i>
                  <span>Burger joints</span>
                </div>
                <div
                  class="suggestion-item"
                  data-type="cuisine"
                  data-value="chinese"
                >
                  <i class="fas fa-chopsticks"></i>
                  <span>Chinese food</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Filter Panel (Slide-out) -->
    <div class="filter-panel" id="filterPanel">
      <div class="filter-header">
        <h3>Filters & Options</h3>
        <button class="close-filter" id="closeFilter">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="filter-content">
        <div class="filter-section">
          <h4>Search Radius</h4>
          <div class="radius-slider">
            <input
              type="range"
              id="radiusSlider"
              min="500"
              max="10000"
              value="5000"
              step="500"
            />
            <div class="radius-display">
              <span id="radiusValue">5.0</span> km
            </div>
          </div>
        </div>

        <div class="filter-section">
          <h4>Price Range</h4>
          <div class="price-filters">
            <button class="price-filter active" data-price="1">$ Budget</button>
            <button class="price-filter" data-price="2">$$ Moderate</button>
            <button class="price-filter" data-price="3">$$$ Upscale</button>
            <button class="price-filter" data-price="4">$$$$ Luxury</button>
          </div>
        </div>

        <div class="filter-section">
          <h4>Rating</h4>
          <div class="rating-filters">
            <button class="rating-filter" data-rating="3">3+ Stars</button>
            <button class="rating-filter active" data-rating="4">
              4+ Stars
            </button>
            <button class="rating-filter" data-rating="4.5">4.5+ Stars</button>
          </div>
        </div>

        <div class="filter-section">
          <h4>Open Now</h4>
          <label class="toggle-switch">
            <input type="checkbox" id="openNowToggle" />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Category Tabs -->
      <div class="category-tabs" id="categoryTabs">
        <button class="category-tab active" data-type="restaurant">
          <i class="fas fa-utensils"></i>
          <span>Restaurants</span>
        </button>
        <button class="category-tab" data-type="cafe">
          <i class="fas fa-coffee"></i>
          <span>Caf√©s</span>
        </button>
        <button class="category-tab" data-type="bakery">
          <i class="fas fa-bread-slice"></i>
          <span>Bakeries</span>
        </button>
        <button class="category-tab" data-type="store">
          <i class="fas fa-store"></i>
          <span>Stores</span>
        </button>
      </div>

      <!-- Quick Action Chips -->
      <div class="quick-actions">
        <div class="action-chips" id="actionChips">
          <button class="action-chip" data-cuisine="pizza">üçï Pizza</button>
          <button class="action-chip" data-cuisine="sushi">üç£ Sushi</button>
          <button class="action-chip" data-cuisine="burger">üçî Burgers</button>
          <button class="action-chip" data-cuisine="coffee">‚òï Coffee</button>
          <button class="action-chip" data-cuisine="indian">üçõ Indian</button>
          <button class="action-chip" data-cuisine="chinese">ü•° Chinese</button>
          <button class="action-chip" data-cuisine="italian">üçù Italian</button>
          <button class="action-chip" data-cuisine="mexican">üåÆ Mexican</button>
        </div>
      </div>

      <!-- Map Container -->
      <div class="map-container" id="mapContainer">
        <div class="map-header">
          <div class="map-controls">
            <button class="map-control-btn" id="centerMapBtn">
              <i class="fas fa-crosshairs"></i>
            </button>
            <button class="map-control-btn" id="listViewBtn">
              <i class="fas fa-list"></i>
            </button>
            <button class="map-control-btn" id="fullscreenBtn">
              <i class="fas fa-expand"></i>
            </button>
          </div>
          <div class="results-counter">
            <span id="resultsCount">0 places found</span>
          </div>
        </div>
        <div id="map" class="map-element"></div>

        <!-- Map Overlay for Mobile -->
        <div class="map-overlay" id="mapOverlay">
          <div class="overlay-handle"></div>
          <div class="overlay-content">
            <div class="overlay-header">
              <h3>Search Results</h3>
              <button class="overlay-toggle" id="overlayToggle">
                <i class="fas fa-chevron-up"></i>
              </button>
            </div>
            <div class="results-container" id="results">
              <div class="empty-state">
                <i class="fas fa-search"></i>
                <h4>Start Your Food Journey</h4>
                <p>
                  Search for restaurants, caf√©s, or any cuisine you're craving!
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Floating Action Button -->
    <div class="fab-container">
      <button class="fab" id="mainFab">
        <i class="fas fa-plus"></i>
      </button>
      <div class="fab-menu" id="fabMenu">
        <button class="fab-action" id="nearbyBtn">
          <i class="fas fa-location-arrow"></i>
          <span>Nearby</span>
        </button>
        <button class="fab-action" id="favoritesBtn">
          <i class="fas fa-heart"></i>
          <span>Favorites</span>
        </button>
        <button class="fab-action" id="shareLocationBtn">
          <i class="fas fa-share-alt"></i>
          <span>Share</span>
        </button>
      </div>
    </div>

    <!-- Bottom Sheet for Place Details -->
    <div class="bottom-sheet" id="bottomSheet">
      <div class="sheet-handle"></div>
      <div class="sheet-content" id="sheetContent">
        <!-- Dynamic content loaded here -->
      </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-784GHrzxkNJfJKZhF4cu9N87ESyk0ZM&libraries=places&callback=initMap"
      async
      defer
    ></script>
    <script src="js/food-finder.js"></script>

    <script>
      // Core functionality preserved but enhanced
      let map,
        service,
        infowindow,
        userLocation,
        markers = [];
      let currentSearchType = "restaurant";
      let searchRadius = 5000;
      let isMapInitialized = false;
      let autocompleteService, placesService;
      let searchTimeout;
      let nearbyPlaces = [];

      function showLoading() {
        document.getElementById("loadingOverlay").classList.add("active");
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.remove("active");
      }

      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
        <i class="fas fa-${type === "error" ? "exclamation-circle" : type === "success" ? "check-circle" : "info-circle"}"></i>
        <span>${message}</span>
      `;
        document.getElementById("toastContainer").appendChild(toast);

        setTimeout(() => toast.classList.add("active"), 100);
        setTimeout(() => {
          toast.classList.remove("active");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      function updateLocationIndicator(location) {
        const indicator = document.getElementById("locationIndicator");
        if (location === "getting") {
          indicator.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Getting location...';
        } else if (location === "error") {
          indicator.innerHTML =
            '<i class="fas fa-exclamation-triangle"></i> Location unavailable';
        } else {
          indicator.innerHTML =
            '<i class="fas fa-map-marker-alt"></i> Current location';
        }
      }

      function clearMarkers() {
        markers.forEach((marker) => marker.setMap(null));
        markers = [];
      }

      function initMap() {
        const defaultLocation = { lat: -26.2041, lng: 28.0473 };

        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultLocation,
          zoom: 14,
          styles: [
            {
              featureType: "all",
              elementType: "geometry.fill",
              stylers: [{ color: "#f5f7fa" }],
            },
            {
              featureType: "road",
              elementType: "geometry",
              stylers: [{ color: "#ffffff" }],
            },
            {
              featureType: "road",
              elementType: "geometry.stroke",
              stylers: [{ color: "#e0e7ff" }],
            },
            {
              featureType: "poi",
              elementType: "geometry.fill",
              stylers: [{ color: "#e8f4f8" }],
            },
            {
              featureType: "water",
              elementType: "geometry.fill",
              stylers: [{ color: "#64b5f6" }],
            },
          ],
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false,
        });

        infowindow = new google.maps.InfoWindow();
        service = new google.maps.places.PlacesService(map);
        autocompleteService = new google.maps.places.AutocompleteService();
        placesService = new google.maps.places.PlacesService(map);
        isMapInitialized = true;

        updateLocationIndicator("getting");

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              map.setCenter(userLocation);

              new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Your Location",
                icon: {
                  url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232196f3'%3E%3Ccircle cx='12' cy='12' r='8'/%3E%3C/svg%3E",
                  scaledSize: new google.maps.Size(20, 20),
                },
              });

              updateLocationIndicator("success");
              hideLoading();
              showToast("Location found successfully!", "success");
            },
            (error) => {
              userLocation = defaultLocation;
              map.setCenter(userLocation);
              updateLocationIndicator("error");
              hideLoading();
              showToast(
                "Could not get your location. Using default location.",
                "error",
              );
            },
          );
        } else {
          userLocation = defaultLocation;
          updateLocationIndicator("error");
          hideLoading();
          showToast("Geolocation not supported by this browser.", "error");
        }
      }

      function searchPlaces(type, keyword = "") {
        if (!userLocation) {
          showToast("Location not available. Please wait...", "error");
          return;
        }

        showLoading();
        clearMarkers();

        const request = {
          location: userLocation,
          radius: searchRadius,
          type: type,
        };

        if (keyword) {
          request.keyword = keyword;
        }

        service.nearbySearch(request, (results, status) => {
          hideLoading();

          if (status === google.maps.places.PlacesServiceStatus.OK) {
            displayResults(results, type);
            addMarkers(results);
            document.getElementById("resultsCount").textContent =
              `${results.length} places found`;
            showToast(`Found ${results.length} ${type}s nearby!`, "success");
          } else {
            document.getElementById("results").innerHTML = getEmptyState();
            document.getElementById("resultsCount").textContent =
              "0 places found";
            showToast(`No ${type}s found nearby.`, "error");
          }
        });
      }

      function getEmptyState() {
        return `
        <div class="empty-state">
          <i class="fas fa-search"></i>
          <h4>No Results Found</h4>
          <p>Try adjusting your search criteria or location.</p>
        </div>
      `;
      }

      function displayResults(places, type) {
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = "";

        if (!places.length) {
          resultsDiv.innerHTML = getEmptyState();
          return;
        }

        places.forEach((place, index) => {
          const placeCard = document.createElement("div");
          placeCard.className = "place-card";
          placeCard.style.animationDelay = `${index * 0.1}s`;

          const rating = place.rating || 0;
          const priceLevel = place.price_level || 0;
          const isOpen = place.opening_hours?.open_now;

          placeCard.innerHTML = `
          <div class="place-image">
            <img src="${place.photos?.[0]?.getUrl({ maxWidth: 300, maxHeight: 200 }) || "https://via.placeholder.com/300x200?text=No+Image"}"
                 alt="${place.name}" loading="lazy">
            <div class="place-badges">
              ${isOpen !== undefined ? `<span class="status-badge ${isOpen ? "open" : "closed"}">${isOpen ? "Open" : "Closed"}</span>` : ""}
              ${priceLevel > 0 ? `<span class="price-badge">${"$".repeat(priceLevel)}</span>` : ""}
            </div>
          </div>
          <div class="place-info">
            <h3 class="place-name">${place.name}</h3>
            <div class="place-rating">
              <div class="stars">
                ${generateStars(rating)}
              </div>
              <span class="rating-text">${rating > 0 ? rating.toFixed(1) : "No rating"}</span>
            </div>
            <p class="place-address">
              <i class="fas fa-map-marker-alt"></i>
              ${place.vicinity}
            </p>
            <div class="place-actions">
              <button class="action-btn-small" onclick="openPlaceDetails('${place.place_id}')">
                <i class="fas fa-info-circle"></i> Details
              </button>
              <button class="action-btn-small" onclick="getDirections(${place.geometry.location.lat()}, ${place.geometry.location.lng()})">
                <i class="fas fa-directions"></i> Directions
              </button>
            </div>
          </div>
        `;

          resultsDiv.appendChild(placeCard);
        });
      }

      function generateStars(rating) {
        let stars = "";
        for (let i = 1; i <= 5; i++) {
          if (i <= rating) {
            stars += '<i class="fas fa-star"></i>';
          } else if (i - 0.5 <= rating) {
            stars += '<i class="fas fa-star-half-alt"></i>';
          } else {
            stars += '<i class="far fa-star"></i>';
          }
        }
        return stars;
      }

      function addMarkers(places) {
        places.forEach((place) => {
          const marker = new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            title: place.name,
            icon: {
              url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ff6b35'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/%3E%3C/svg%3E",
              scaledSize: new google.maps.Size(30, 30),
            },
          });

          markers.push(marker);

          marker.addListener("click", () => {
            openPlaceDetails(place.place_id);
          });
        });
      }

      function openPlaceDetails(placeId) {
        const request = { placeId: placeId };

        service.getDetails(request, (place, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            showPlaceDetails(place);
          }
        });
      }

      function showPlaceDetails(place) {
        const bottomSheet = document.getElementById("bottomSheet");
        const sheetContent = document.getElementById("sheetContent");

        const photos = place.photos || [];
        const rating = place.rating || 0;
        const reviews = place.reviews || [];

        sheetContent.innerHTML = `
        <div class="place-details">
          <div class="place-header">
            <h2>${place.name}</h2>
            <button class="close-sheet" onclick="closeBottomSheet()">
              <i class="fas fa-times"></i>
            </button>
          </div>

          ${
            photos.length > 0
              ? `
            <div class="place-photos">
              ${photos
                .slice(0, 3)
                .map(
                  (photo) =>
                    `<img src="${photo.getUrl({ maxWidth: 400, maxHeight: 300 })}" alt="${place.name}">`,
                )
                .join("")}
            </div>
          `
              : ""
          }

          <div class="place-meta">
            <div class="rating-section">
              <div class="stars">${generateStars(rating)}</div>
              <span>${rating > 0 ? rating.toFixed(1) : "No rating"} (${place.user_ratings_total || 0} reviews)</span>
            </div>

            <div class="contact-info">
              <p><i class="fas fa-map-marker-alt"></i> ${place.formatted_address}</p>
              ${place.formatted_phone_number ? `<p><i class="fas fa-phone"></i> ${place.formatted_phone_number}</p>` : ""}
              ${place.website ? `<p><i class="fas fa-globe"></i> <a href="${place.website}" target="_blank">Website</a></p>` : ""}
            </div>

            ${
              place.opening_hours
                ? `
              <div class="hours-section">
                <h4>Opening Hours</h4>
                ${place.opening_hours.weekday_text.map((day) => `<p>${day}</p>`).join("")}
              </div>
            `
                : ""
            }

            <div class="action-buttons">
              <button class="detail-action-btn primary" onclick="getDirections(${place.geometry.location.lat()}, ${place.geometry.location.lng()})">
                <i class="fas fa-directions"></i> Get Directions
              </button>
              <button class="detail-action-btn secondary" onclick="sharePlace('${place.name}', '${place.formatted_address}')">
                <i class="fas fa-share"></i> Share
              </button>
            </div>
          </div>
        </div>
      `;

        bottomSheet.classList.add("active");
      }

      function closeBottomSheet() {
        document.getElementById("bottomSheet").classList.remove("active");
      }

      function getDirections(lat, lng) {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
        window.open(url, "_blank");
      }

      function sharePlace(name, address) {
        if (navigator.share) {
          navigator.share({
            title: name,
            text: `Check out ${name}`,
            url: window.location.href,
          });
        } else {
          navigator.clipboard.writeText(`${name} - ${address}`);
          showToast("Place details copied to clipboard!", "success");
        }
      }

      // Safe querySelector wrapper to prevent '#' errors
      function safeQuerySelector(selector) {
        try {
          if (selector === "#" || selector === "" || !selector) {
            console.warn("Invalid selector provided:", selector);
            return null;
          }
          return document.querySelector(selector);
        } catch (error) {
          console.error("querySelector error:", error, "Selector:", selector);
          return null;
        }
      }

      // Initialize when page loads
      window.onload = () => {
        showLoading();
        if (typeof initMap === "function") {
          initMap();
        }
      };

      // Event Listeners
      document.addEventListener("DOMContentLoaded", () => {
        // Category tabs
        document.querySelectorAll(".category-tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            document
              .querySelectorAll(".category-tab")
              .forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            currentSearchType = tab.dataset.type;
            searchPlaces(currentSearchType);
          });
        });

        // Action chips
        document.querySelectorAll(".action-chip").forEach((chip) => {
          chip.addEventListener("click", () => {
            const cuisine = chip.dataset.cuisine;
            searchPlaces("restaurant", cuisine);
          });
        });

        // Quick search
        document
          .getElementById("quickSearch")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              const query = e.target.value.trim();
              if (query) {
                searchPlaces("restaurant", query);
              }
            }
          });

        // Filter panel
        document.getElementById("menuToggle").addEventListener("click", () => {
          document.getElementById("filterPanel").classList.add("active");
        });

        document.getElementById("closeFilter").addEventListener("click", () => {
          document.getElementById("filterPanel").classList.remove("active");
        });

        // Radius slider
        document
          .getElementById("radiusSlider")
          .addEventListener("input", (e) => {
            searchRadius = parseInt(e.target.value);
            document.getElementById("radiusValue").textContent = (
              searchRadius / 1000
            ).toFixed(1);
          });

        // Map controls
        document
          .getElementById("centerMapBtn")
          .addEventListener("click", () => {
            if (map && userLocation) {
              map.setCenter(userLocation);
              map.setZoom(14);
            }
          });

        // FAB menu
        document.getElementById("mainFab").addEventListener("click", () => {
          document.getElementById("fabMenu").classList.toggle("active");
        });

        document.getElementById("nearbyBtn").addEventListener("click", () => {
          searchPlaces(currentSearchType);
          document.getElementById("fabMenu").classList.remove("active");
        });

        // Overlay toggle for mobile
        document
          .getElementById("overlayToggle")
          .addEventListener("click", () => {
            document.getElementById("mapOverlay").classList.toggle("expanded");
          });

        // Prevent querySelector '#' errors by safely handling anchor links
        document.addEventListener("click", (e) => {
          if (
            e.target.tagName === "A" &&
            e.target.getAttribute("href") === "#"
          ) {
            e.preventDefault();
            return false;
          }
        });

        // Override any problematic smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
          if (anchor.getAttribute("href") === "#") {
            anchor.addEventListener("click", function (e) {
              e.preventDefault();
              return false;
            });
          } else {
            anchor.addEventListener("click", function (e) {
              e.preventDefault();
              const target = document.querySelector(this.getAttribute("href"));
              if (target) {
                target.scrollIntoView({
                  behavior: "smooth",
                  block: "start",
                });
              }
            });
          }
        });
      });
    </script>
  </body>
</html>
